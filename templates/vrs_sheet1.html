<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRS 청소 Check Sheet</title>
    <link rel="stylesheet" href="/static/fqa1.css">
</head>
<body>

    <div class="container">
        <div class="info-section">
            <p><strong>Year:</strong> {{ year }}</p>
            <p><strong>Month:</strong> {{ month }}</p>
            <p><strong>Team:</strong> {{ team }}</p>
            <p><strong>Worker:</strong> {{ worker }}</p>
            <p><strong>Manager:</strong> {{ manager }}</p>
            <p><strong>Equipment ID:</strong> {{ equipment_id }}</p>
        </div>

        <div class="table-section">
            <div class="title">VRS 설비점검 Check Sheet</div>

            <!-- 표 구성 -->
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>점검 항목</th>
                        <th>점검 방법</th>
                        <th>관리 범위</th>
                        <th>점검 주기</th>
                        <th>확인</th> <!-- 확인 컬럼 추가 -->
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>LED</td>
                        <td>점등상태</td>
                        <td></td>
                        <td>1회/Shift</td>
                        <td><input type="checkbox" class="toggle-checkbox" data-id="1"></td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>현미경</td>
                        <td>점등상태</td>
                        <td></td>
                        <td>1회/Shift</td>
                        <td><input type="checkbox" class="toggle-checkbox" data-id="2"></td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>자바라</td>
                        <td>"이물 및 오염여부, 파손 및 노후 상태"</td>
                        <td>이물 오염 파손등 없을것</td>
                        <td>1회/Shift</td>
                        <td><input type="checkbox" class="toggle-checkbox" data-id="3"></td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>Boat</td>
                        <td>이물 및 오염 파손 여부 확인</td>
                        <td>이물 오염 파손 없을것</td>
                        <td>1회/Shift</td>
                        <td><input type="checkbox" class="toggle-checkbox" data-id="4"></td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>양/불 적재판</td>
                        <td>이물 및 오염여부 확인</td>
                        <td>이물 오염 파손 없을것</td>
                        <td>1회/Shift</td>
                        <td><input type="checkbox" class="toggle-checkbox" data-id="5"></td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td>설비 외관</td>
                        <td>이물 및 오염여부 확인</td>
                        <td>이물 오염 파손 없을것</td>
                        <td>1회/Shift</td>
                        <td><input type="checkbox" class="toggle-checkbox" data-id="6"></td>
                    </tr>
                    <tr>
                        <td>7</td>
                        <td>Regulator 교체</td>
                        <td>정기 교체</td>
                        <td></td>
                        <td>정기 교체 1회/3개월</td>
                        <td>
                            <span id="item-7-last-replacement">마지막 교체일: </span><br>
                            <span id="item-7-next-replacement">다음 교체일: </span>
                            <input type="hidden" class="toggle-button" data-id="7" value="0">
                            <button class="confirm-button" data-id="7" onclick="confirmChange('Regulator', 7, 90, {{ equipment_id }})">교체</button>
                        </td>
                    </tr>
                    <tr>
                        <td>8</td>
                        <td>Boat Pad</td>
                        <td>정기 교체</td>
                        <td></td>
                        <td>정기 교체 1회/1년</td>
                        <td>
                            <span id="item-8-last-replacement">마지막 교체일: </span><br>
                            <span id="item-8-next-replacement">다음 교체일: </span>
                            <input type="hidden" class="toggle-button" data-id="8" value="0">
                            <button class="confirm-button" data-id="8" onclick="confirmChange('Boat Pad', 8, 365,{{ equipment_id }})">교체</button>
                        </td>
                    </tr>
                    <tr>
                        <td>9</td>
                        <td>자바라 교체</td>
                        <td>정기 교체</td>
                        <td></td>
                        <td>정기 교체 1회/5년, 파손 및 노후시 즉시 교체</td>
                        <td>
                            <span id="item-9-last-replacement">마지막 교체일: </span><br>
                            <span id="item-9-next-replacement">다음 교체일: </span>
                            <input type="hidden" class="toggle-button" data-id="9" value="0">
                            <button class="confirm-button" data-id="9" onclick="confirmChange('자바라', 9, 1825, {{ equipment_id }})">교체</button>
                        </td>

                        
                    </tr>
                </tbody>
            </table>

            <!-- 비고 입력 필드 추가 -->
            <div class="form-group">
                <label for="remark">비고:</label>
                <textarea id="remark" name="remark" rows="3" cols="50"></textarea>
            </div>
            <div class="form-group button-group">
                <button onclick="selectAll()">모든 항목 점검</button>
                <button onclick="submitData()">체크 완료</button>
            </div>
            
            <div class="back-button-container">
                <button class="back-button" onclick="goBack()">Back</button>
            </div>
            <div class="form-group next-sheet-button">
                <button onclick="goToNextSheet()">다음 시트</button>
            </div>
            
        </div>
    </div>

    <script>
        window.onload = function() {
            // 현재 시트 이름을 정의 (예: vrs_sheet1)
            const sheetName = "vrs_sheet1";  // 시트 이름
            const equipmentId = "{{ equipment_id }}";  // 서버에서 전달된 equipment_id 사용
        
            // 교체 주기 데이터를 서버에서 불러옴
            fetch(`/get/replacement_schedule/${sheetName}?equipment_id=${equipmentId}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    if (data.replacement_data) {
                        data.replacement_data.forEach(item => {
                            // 각 항목의 교체 주기 데이터를 UI에 표시
                            document.querySelector(`#item-${item.item_id}-last-replacement`).textContent = `마지막 교체: ${item.last_replacement_date}`;
                            document.querySelector(`#item-${item.item_id}-next-replacement`).textContent = `다음 교체: ${item.next_replacement_date}`;
                        });
                    } else {
                        console.log("No replacement data found for this equipment.");
                    }
                })
                .catch(error => {
                    console.error('Error fetching replacement data:', error);
                });
        };
        
        // 뒤로 가기 기능
        function goBack() {
            window.history.back(); 
        }
        
        // 모든 체크박스 선택 기능
        function selectAll() {
            const checkboxes = document.querySelectorAll('.toggle-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        function confirmChange(item, id, intervalDays, equipmentId) {
            // 확인 로그 추가
            console.log(`Confirming change for item: ${item}, equipment_id: ${equipmentId}`);
            const confirmed = confirm(`${item}를 교체처리할까요?`);
            if (confirmed) {
                alert('Replacement confirmed');
                document.querySelector(`input.toggle-button[data-id="${id}"]`).value = "1";
                
                // 교체 완료 후 버튼 숨기기
                const button = document.querySelector(`button[data-id="${id}"]`);
                if (button) {
                    button.style.display = 'none';  // 버튼을 숨김
                }

                const today = new Date().toISOString().split('T')[0];
                // const today = '2024-09-16'; // Test 날짜
                const nextReplacementDate = new Date();
                nextReplacementDate.setDate(nextReplacementDate.getDate() + intervalDays);
                const formattedNextDate = nextReplacementDate.toISOString().split('T')[0];
        
                document.querySelector(`#item-${id}-last-replacement`).textContent = `마지막 교체일: ${today}`;
                document.querySelector(`#item-${id}-next-replacement`).textContent = `다음 교체일: ${formattedNextDate}`;
        
                const data = {
                    sheet_name: "vrs_sheet1",
                    item_id: id,
                    last_replacement_date: today,
                    next_replacement_date: formattedNextDate,
                    replacement_interval_days: intervalDays,
                    equipment_id: equipmentId  // 장비 호기 추가
                };
        
                fetch('/update/replacement_schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    console.log(result.message);
                })
                .catch(error => {
                    console.error('Error updating replacement schedule:', error);
                });
            } else {
                alert('Replacement canceled');
            }
        }
        
        // 체크 완료 데이터 수집 및 서버로 전송
        function submitData() {
            const checkboxes = document.querySelectorAll('.toggle-checkbox');
            const unchecked = Array.from(checkboxes).some(checkbox => !checkbox.checked);
            const sheetName = "vrs_sheet1";  // 시트 이름
        
            if (unchecked) {
                alert("모든 체크 항목을 완료해 주세요.");
                return;
            }
        
        
            // 교체 주기 확인
            fetch(`/check/replacement_dates/${sheetName}?equipment_id={{ equipment_id }}`)
                .then(response => response.json())
                .then(result => {
                    if (!result.allValid) {
                        alert("교체해야 하는 항목이 있습니다. 교체 후 진행해주세요.");
                        return;
                    }
        
                    // 한 번만 "체크 완료" 확인
                    if (confirm("정말로 체크 완료하시겠습니까?")) {
                        const toggleButtons = document.querySelectorAll('.toggle-button');
                        const remark = document.querySelector('#remark').value;  // 비고 입력 값
        
                        const data = {
                            team: "{{ team }}",
                            worker: "{{ worker }}",
                            manager: "{{ manager }}",
                            equipment_id: "{{ equipment_id }}",
                            date: new Date().toISOString().slice(0, 10).replace(/-/g, "").slice(2),  // yymmdd 형식 날짜
                            checks: []
                        };
        
                        checkboxes.forEach(checkbox => {
                            data.checks.push({
                                id: checkbox.dataset.id,
                                checked: checkbox.checked ? 1 : 0
                            });
                        });
        
                        toggleButtons.forEach(button => {
                            data.checks.push({
                                id: button.dataset.id,
                                checked: button.value
                            });
                        });
        
                        // 체크리스트 데이터 전송
                        fetch('/save/vrs_sheet1', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        })
                        .then(response => response.json())
                        .then(result => {
                            alert(result.message);
                            goToNextSheet();  // 데이터 전송 후 다음 시트로 이동
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
        
                        // 비고 데이터가 있는 경우 비고 데이터 전송
                        if (remark.trim() !== "") {
                            const remarkData = {
                                process: "VRS",
                                team: "{{ team }}",
                                manager: "{{ manager }}",
                                equipment_id: "{{ equipment_id }}",  // 장비 호기 포함
                                remark: remark,
                                date: data.date
                            };
        
                            fetch('/save/remark', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(remarkData)
                            })
                            .then(response => response.json())
                            .then(result => {
                                console.log(result.message);
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        // 다음 시트로 이동
        function goToNextSheet() {
            const currentUrl = window.location.href;
            const nextSheetUrl = currentUrl.replace("sheet1", "sheet2");
            window.location.href = nextSheetUrl;
        }
        </script>
        
    
</body>
</html>
